name: EBS Build

on:
  workflow_dispatch:
    inputs:
      Jira_No:
        description: Jira ticket number
        required: true
      FileNames:
        description: Comma separated file names
        required: false
      CUSTOM_TOP:
        description: Custom top value
        required: true
        default: $XXDEMO_TOP
        type: choice
        options:
        - $XXDEMO_TOP
        - $XXDEMOC_TOP
      Repo_Directory:
        description: directory path in repository 
        required: true

env:
  # Static / migrated ADO variable equivalents (override in repo or add to workflow_dispatch inputs)
  BASE_PATH: "/u01/buildsrv/EBSHOME"
  LIVE: Github_Demo                # <- set to your runtime folder name
  CUSTOM_TOP: ${{ inputs.CUSTOM_TOP }}
  FileNames: ${{ inputs.FileNames }}
  Jira_No: ${{ inputs.Jira_No }}
  Repo_Directory: ${{ inputs.Repo_Directory }}
  BUILD_NUMBER: ${{ github.run_number }}
  REQUESTED_FOR: ${{ github.actor }}
  REQUESTED_FOR_EMAIL: "abcd@abcd.com"    # Not directly available in GitHub; supply via secret or input if needed
  GIT_AUTHOR_NAME: github-actions
  GIT_AUTHOR_EMAIL: actions@users.noreply.github.com

jobs:
  ebs-build:
    name: EBS-Build
    runs-on: LTIM-buildsrv

    steps:
      - name: Checkout (main)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0   # get tags
          fetch-tags: true

      - name: Semgrep installation
        run: |
          pip install semgrep

      - name: Run Semgrep Scan
        run: |
          semgrep --config "p/owasp-top-ten" \
                  --config "p/java" \
                  --config "p/sql" \
                  --include '*.java' \
                  --include '*.sql' \
                  --sarif --output semgrep-results.sarif

      - name: Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep-results.sarif
